# 云服务器部署指导

## 1. 云服务器准备

### 1.1 创建云服务器实例
- 选择主流云服务商（阿里云、腾讯云、AWS等）
- 推荐使用 **Ubuntu 20.04 LTS** 或 **Ubuntu 22.04 LTS** 操作系统
- 实例规格：至少2核4G内存（根据实际访问量调整）
- 存储：至少40GB SSD磁盘

### 1.2 配置安全组
开放以下端口：
- **80**：HTTP访问
- **443**：HTTPS访问（可选，生产环境建议启用）
- **22**：SSH访问（仅允许特定IP段访问，提高安全性）

## 2. 环境搭建

### 2.1 登录云服务器
使用SSH工具（如PuTTY、Terminal）登录服务器：
```bash
ssh root@your-server-ip
```

### 2.2 更新系统软件包
```bash
sudo apt update && sudo apt upgrade -y
```

### 2.3 安装Docker
```bash
# 安装依赖
 sudo apt install -y apt-transport-https ca-certificates curl gnupg-agent software-properties-common

# 添加Docker GPG密钥
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -

# 添加Docker软件源
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"

# 安装Docker引擎
sudo apt update && sudo apt install -y docker-ce docker-ce-cli containerd.io

# 启动Docker并设置开机自启
sudo systemctl start docker && sudo systemctl enable docker

# 验证Docker安装
sudo docker --version
```

### 2.4 安装Docker Compose
```bash
# 下载最新稳定版Docker Compose
 sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

# 赋予执行权限
sudo chmod +x /usr/local/bin/docker-compose

# 验证Docker Compose安装
docker-compose --version
```

## 3. 代码部署

### 3.1 克隆项目代码
```bash
# 安装Git
sudo apt install -y git

# 克隆代码到服务器
git clone <your-repository-url> /opt/interview-system

# 进入项目目录
cd /opt/interview-system
```

### 3.2 配置环境变量
根据实际需求修改`.env`文件：
```bash
# 编辑环境变量文件
vim .env

# 主要配置项说明：
# SECRET_KEY：修改为随机字符串，用于JWT加密
# DATABASE_URL：数据库连接字符串，默认已配置好
# REDIS_URL：Redis连接字符串，默认已配置好
# DEBUG：生产环境建议设置为False
```

### 3.3 赋予脚本执行权限
```bash
chmod +x *.sh
```

## 4. 服务启动

### 4.1 运行部署脚本
```bash
# 执行部署脚本
./deploy.sh
```

部署脚本会自动执行以下操作：
1. 构建前端应用
2. 停止并移除旧容器
3. 构建并启动新容器
4. 检查服务健康状态

### 4.2 查看部署进度
部署过程中，脚本会输出详细的日志信息，包括：
- 前端构建状态
- 容器启动状态
- 服务健康检查结果

## 5. 验证部署

### 5.1 访问应用
部署成功后，通过浏览器访问：
- 前端应用：`http://your-server-ip`
- 后端API：`http://your-server-ip/api`
- 健康检查：`http://your-server-ip/health`

### 5.2 查看服务状态
```bash
# 查看所有容器状态
docker-compose ps

# 查看服务日志
./check_logs.sh
```

### 5.3 验证功能
1. 注册新用户
2. 创建新项目
3. 启动访谈
4. 测试访谈功能
5. 测试导出功能

## 6. 后续维护

### 6.1 更新代码
```bash
# 进入项目目录
cd /opt/interview-system

# 拉取最新代码
git pull

# 重新部署
./deploy.sh
```

### 6.2 重启服务
```bash
# 重启所有服务
docker-compose restart

# 重启单个服务（如应用服务）
docker-compose restart app
```

### 6.3 查看日志
```bash
# 查看所有服务日志（最新50行）
./check_logs.sh

# 实时查看单个服务日志
docker logs -f interview_app_container
```

### 6.4 备份数据
```bash
# 备份数据库数据
cp -r ./pg_data /path/to/backup/

# 备份Redis数据
cp -r ./redis_data /path/to/backup/
```

## 7. 生产环境优化建议

### 7.1 启用HTTPS
1. 获取SSL证书（如Let's Encrypt）
2. 修改Nginx配置，启用HTTPS
3. 重定向HTTP到HTTPS

### 7.2 配置域名
1. 将域名解析到云服务器IP
2. 修改Nginx配置中的`server_name`

### 7.3 增强安全性
1. 设置复杂的数据库和Redis密码
2. 限制SSH访问IP
3. 定期更新系统和Docker镜像
4. 配置防火墙规则

### 7.4 监控和告警
1. 安装监控工具（如Prometheus、Grafana）
2. 设置服务健康告警
3. 配置日志监控

## 8. 常见问题排查

### 8.1 容器启动失败
```bash
# 查看容器日志
docker logs <container-name>
```

### 8.2 端口占用
```bash
# 查看端口占用情况
lsof -i :<port>

# 终止占用端口的进程
kill <pid>
```

### 8.3 数据库连接失败
- 检查数据库容器是否正常运行
- 检查数据库连接字符串是否正确
- 检查数据库密码是否正确

### 8.4 Redis连接失败
- 检查Redis容器是否正常运行
- 检查Redis连接字符串是否正确
- 检查Redis密码是否正确

通过以上步骤，您应该能够顺利将项目部署到云服务器上。如果遇到问题，可以查看日志或参考Docker和Docker Compose的官方文档。